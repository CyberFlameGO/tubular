default-flavor: buster

buster: &buster
  build:
    builddeps:
      - build-essential
      - crossbuild-essential-arm64
      - rubygem-fpm
      - clang-9
      - go
    post-cache:
      - CC=x86_64-linux-gnu-gcc ARCH=amd64 make package
      - CC=aarch64-linux-gnu-gcc ARCH=arm64 make package
      - git diff --exit-code || { echo "generated files are not up to date" >&2; false; }
  test:
    privileged:
      - true
    builddeps:
      - build-essential
      - clang-9
      - go
      - qemu-system-x86
      - python3-virtme=0.0.3-4
      - wget
    post-cache:
      - CC=x86_64-linux-gnu-gcc ARCH=amd64 make all
      - git diff --exit-code || { echo "generated files are not up to date" >&2; false; }
      # Redirect stdin to prevent a weird interaction between QEMU
      # and Docker redirecting stdin to /dev/null.
      - sudo chgrp $(id -g) /dev/kvm
      - ./run-tests.sh GOFLAGS=-json make test < /dev/zero
      - ./run-tests.sh make cover < /dev/zero && mkdir .cover && mv coverage.html .cover/all.html

stretch:
  <<: *buster
